# VPS Stack: n8n + CLI Tools
#
# Usage:
#   Development:  docker-compose up -d
#   Production:   docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d

services:
  # ===========================================
  # n8n Workflow Automation
  # ===========================================
  n8n:
    image: docker.n8n.io/n8nio/n8n:latest
    container_name: n8n
    restart: unless-stopped
    ports:
      - "${N8N_PORT:-5678}:5678"
    environment:
      # Basic settings
      - N8N_HOST=${N8N_HOST:-localhost}
      - N8N_PORT=5678
      - N8N_PROTOCOL=${N8N_PROTOCOL:-http}
      - NODE_ENV=production
      - WEBHOOK_URL=${WEBHOOK_URL:-http://localhost:5678/}

      # Encryption key for credentials
      - N8N_ENCRYPTION_KEY=${N8N_ENCRYPTION_KEY}

      # Timezone
      - GENERIC_TIMEZONE=${TIMEZONE:-America/Costa_Rica}
      - TZ=${TIMEZONE:-America/Costa_Rica}

      # Features
      - N8N_DIAGNOSTICS_ENABLED=${N8N_DIAGNOSTICS_ENABLED:-false}
      - N8N_PERSONALIZATION_ENABLED=false

      # API Keys (passed to CLI tools via shared env)
      - GOOGLE_AI_API_KEY=${GOOGLE_AI_API_KEY:-}

    volumes:
      - n8n_data:/home/node/.n8n
      - ./workflows:/home/node/workflows
      - ./local-files:/files
      # Shared volume for file exchange with cli-tools
      - shared_data:/data/shared
    depends_on:
      - cli-tools
    networks:
      - vps-network

  # ===========================================
  # CLI Tools Container (Dynamic Loading)
  # ===========================================
  cli-tools:
    build:
      context: ./cli-tools
      dockerfile: Dockerfile
    image: cli-tools:latest
    container_name: cli-tools
    restart: unless-stopped
    environment:
      # Auto-update: set to true to pull latest from GitHub on restart
      - CLI_TOOLS_UPDATE_CHECK=${CLI_TOOLS_UPDATE_CHECK:-true}
      - CLI_TOOLS_AUTO_UPDATE=${CLI_TOOLS_AUTO_UPDATE:-false}
      # API Keys
      - GOOGLE_AI_API_KEY=${GOOGLE_AI_API_KEY:-}
    volumes:
      # Shared volume for file exchange with n8n
      - shared_data:/data/shared
      # Local files access
      - ./local-files:/files
      # Persist cloned repos (avoids re-cloning on restart)
      - cli_tools_repos:/opt/cli-tools
    networks:
      - vps-network
    # Keep container running for n8n to execute commands
    command: ["tail", "-f", "/dev/null"]

networks:
  vps-network:
    driver: bridge

volumes:
  n8n_data:
    name: n8n_data
  shared_data:
    name: vps_shared_data
  cli_tools_repos:
    name: cli_tools_repos
