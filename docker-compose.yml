# VPS Stack: n8n + CLI Tools
#
# Usage:
#   Development:  docker-compose up -d
#   Production:   docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d

services:
  # ===========================================
  # n8n Workflow Automation
  # ===========================================
  n8n:
    image: docker.n8n.io/n8nio/n8n:latest
    container_name: n8n
    restart: unless-stopped
    ports:
      - "${N8N_PORT:-5678}:5678"
    environment:
      # Basic settings
      - N8N_HOST=${N8N_HOST:-localhost}
      - N8N_PORT=5678
      - N8N_PROTOCOL=${N8N_PROTOCOL:-http}
      - NODE_ENV=production
      - WEBHOOK_URL=${WEBHOOK_URL:-http://localhost:5678/}

      # Encryption key for credentials
      - N8N_ENCRYPTION_KEY=${N8N_ENCRYPTION_KEY}

      # Timezone
      - GENERIC_TIMEZONE=${TIMEZONE:-America/Costa_Rica}
      - TZ=${TIMEZONE:-America/Costa_Rica}

      # Editor & Webhooks (required for OAuth2 redirect URIs)
      - N8N_EDITOR_BASE_URL=${N8N_EDITOR_BASE_URL:-http://localhost:5678/}

      # Binary data & community packages
      - N8N_DEFAULT_BINARY_DATA_MODE=filesystem
      - N8N_COMMUNITY_PACKAGES_ALLOW_TOOL_USAGE=true

      # Branding
      - N8N_CUSTOM_INSTANCE_NAME=${N8N_INSTANCE_NAME:-n8n}

      # API access (for pushing workflows via CLI/scripts)
      - N8N_PUBLIC_API_DISABLED=false

      # Features
      - N8N_DIAGNOSTICS_ENABLED=${N8N_DIAGNOSTICS_ENABLED:-false}
      - N8N_PERSONALIZATION_ENABLED=false

      # API Keys (passed to CLI tools via shared env)
      - GOOGLE_AI_API_KEY=${GOOGLE_AI_API_KEY:-}

    volumes:
      - n8n_data:/home/node/.n8n
      - ./workflows:/home/node/workflows
      - ./local-files:/files
      # Custom branding (override n8n defaults)
      - ./local-files/favicon.ico:/usr/local/lib/node_modules/n8n/node_modules/.pnpm/n8n-editor-ui@file+packages+frontend+editor-ui/node_modules/n8n-editor-ui/dist/favicon.ico:ro
      - ./local-files/index.html:/usr/local/lib/node_modules/n8n/node_modules/.pnpm/n8n-editor-ui@file+packages+frontend+editor-ui/node_modules/n8n-editor-ui/dist/index.html:ro
      # Shared volume for file exchange with cli-tools
      - shared_data:/data/shared
    depends_on:
      - cli-tools
    networks:
      - vps-network

  # ===========================================
  # n8n MCP Server (AI Workflow Management)
  # ===========================================
  n8n-mcp:
    image: ghcr.io/czlonkowski/n8n-mcp:latest
    container_name: n8n-mcp
    restart: unless-stopped
    ports:
      - "${N8N_MCP_PORT:-3100}:3000"
    environment:
      - MCP_MODE=http
      - AUTH_TOKEN=${N8N_MCP_AUTH_TOKEN}
      - N8N_API_URL=http://n8n:5678
      - N8N_API_KEY=${N8N_API_KEY}
      - LOG_LEVEL=${N8N_MCP_LOG_LEVEL:-error}
      - N8N_MCP_TELEMETRY_DISABLED=true
    depends_on:
      - n8n
    networks:
      - vps-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ===========================================
  # CLI Tools Container (Dynamic Loading)
  # ===========================================
  cli-tools:
    build:
      context: ./cli-tools
      dockerfile: Dockerfile
    image: cli-tools:latest
    container_name: cli-tools
    restart: unless-stopped
    environment:
      # Auto-update: set to true to pull latest from GitHub on restart
      - CLI_TOOLS_UPDATE_CHECK=${CLI_TOOLS_UPDATE_CHECK:-true}
      - CLI_TOOLS_AUTO_UPDATE=${CLI_TOOLS_AUTO_UPDATE:-false}
      # API Keys
      - GOOGLE_AI_API_KEY=${GOOGLE_AI_API_KEY:-}
      # dbt profiles directory
      - DBT_PROFILES_DIR=${DBT_PROFILES_DIR:-/data/shared/dbt}
    volumes:
      # Shared volume for file exchange with n8n
      - shared_data:/data/shared
      # Local files access
      - ./local-files:/files
      # Persist cloned repos (avoids re-cloning on restart)
      - cli_tools_repos:/opt/cli-tools
    networks:
      - vps-network
    # Keep container running for n8n to execute commands
    command: ["tail", "-f", "/dev/null"]

networks:
  vps-network:
    driver: bridge

volumes:
  n8n_data:
    name: vps_stack_n8n_data
  shared_data:
    name: vps_shared_data
  cli_tools_repos:
    name: cli_tools_repos
